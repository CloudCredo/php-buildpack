#!/usr/bin/env ruby

require 'json'
require 'yaml'
require 'fileutils'

FileUtils.rm('manifest.yml')

binaries = {}
binaries['lucid64'] = JSON.parse(File.read(File.join('binaries', 'lucid', 'index-all.json')))
binaries['cflinuxfs2'] = JSON.parse(File.read(File.join('binaries', 'trusty', 'index-all.json')))

dependencies = []

url_to_dependency_map = []

binaries.each do |rootfs, rootfs_dependencies|
  rootfs_dependencies.each do |dependency_name, dependency_versions|
    dependency_versions.each do |version, version_uris|
      version_uris.each do |uri|
        next if uri.include?('sha1')

        dependency = {}
        if uri.include?('composer.phar')
          dependency['name'] = dependency_name
        else
          dependency['name'] = uri.match("/#{version}/(.*)-#{version}")[1]
        end

        dependency['version'] = version
        dependency['uri'] = uri
        dependency['cf_stacks'] = [rootfs]

        rootfs_dir = rootfs == 'lucid64' ? 'lucid' : 'trusty'

        if uri.include?('composer.phar')
          local_uri = "binaries/#{rootfs_dir}/#{dependency_name}/#{version}/composer.phar"
        else
          local_uri = "binaries/#{rootfs_dir}/#{dependency_name}/#{version}/#{dependency['name']}-#{version}.tar.gz"
        end

        dependency['md5'] = `md5 -q #{local_uri}`.chomp

        dependencies << dependency
      end
    end
  end
end


map = {}
map['match'] = '([^\/]*)-(\d+\.\d+\.\d+)'
map['name'] = '$1'
map['version'] = '$2'

composer_map = {}
composer_map['match'] = '\/composer\/(.*)\/composer.phar'
composer_map['name'] = 'composer'
composer_map['version'] = '$1'


manifest = {}
manifest['url_to_dependency_map'] = [map, composer_map]
manifest['dependencies'] = dependencies

File.open('manifest.yml', 'w') do |file|
  file.write(manifest.to_yaml)
end
